{% extends "base.html" %}
{% load i18n %}

{% block content %}
<span id="scan_release" class="info_box white_font">{{ sb.scan.tag.release.product }} release {{ sb.scan.tag.release.release }}</span>
<span id="scan_state" class="info_box black_font bg_{{ sb.scan.get_state_display }}">{{ sb.scan.get_state_display }}</span>
<h1>{{ compare_title }}</h1>


{% if sb.result %} {# display BZ related info only if scan finished #}

<div id="bz_wrapper">
    {% if not bugzilla %}
        {% if unreported_bugs_count > 0 %}
    <a id="bz_create" href="{% url waiving/new_bz sb.scan.package.id sb.scan.tag.release.id %}">Create Bugzilla</a>
    <span id="bz_bugs_count">{{ unreported_bugs_count }}</span>
        {% endif %}
    {% else %}
    <a id="bz_number" href="https://bugzilla.redhat.com/show_bug.cgi?id={{ bugzilla.number }}">BZ#{{ bugzilla.number }}</a>
        {% if unreported_bugs_count > 0 %}
        <a id="bz_update" href="{% url waiving/update_bz sb.scan.package.id sb.scan.tag.release.id %}">Update Bugzilla</a>
        <span id="bz_bugs_count">{{ unreported_bugs_count }}</span>
        {% endif %}
    {% endif %}
</div>

{% endif %}

<div id="legend_wrapper">
    <h4>Legend</h4>
    <table class="legend">
        <tr>
            <td class="bg_IS_A_BUG">
                Is a bug
            </td>
            <td class="bg_NEEDS_INSPECTION">
                Needs Inspection (<span class="NEW">defects count</span>)
            </td>
            <td class="bg_INFO">
                Info (<span class="FIXED">defects count</span>)
            </td>
            <td class="bg_WAIVED">
                Waived <span class="defects_increased">diff count</span>
            </td>
            <td class="bg_PASSED">
                Passed <span class="defects_decreased">diff count</span>
            </td>
            <td id="active" class="bg_PREVIOUSLY_WAIVED">
                Previously Waived (active)
            </td>
        </tr>
    </table>
</div>

{% if sb.result %} {# display defects list only if scan finished #}

<h3>Newly introduced defects</h3>

{% if status_message %}
<div id="status_messages">{{ status_message }}</div>
{% endif %}

{% if output_new %}
<table class="summary">
{% for five in output_new %}
  <tr>
    {% for group, data in five.items %}
        {% if data and data.id %}
        <td class="bg_{{ data.group_state }}"
            {% if active_group and active_group.id == data.id %}
                id="active"
            {% endif %}
        >
            <a href="{% url waiving/waiver sb.id data.id %}#defects">
                {{ group.name }}
            </a>
            {% if data.defects_state %}
            (<span class="{{ data.defects_state }}">{{ data.defects_count }}</span>)
            {% endif %}
            {% if data.diff_state %}
            <span class="{{ data.diff_state }}">{{ data.diff_count }}</span>
            {% endif %}
        </td>
        {% else %}
        <td class="bg_PASSED">
            {{ group.name }}
            {% if data.diff_state %}
            <span class="{{ data.diff_state }}">{{ data.diff_count }}</span>
            {% endif %}
        </td>
        {% endif %}
    {% endfor %}
  </tr>
{% endfor %}
</table>
{% endif %}

<h3>Fixed defects</h3>
{% if output_fixed %}
<table class="summary">
{% for five in output_fixed %}
  <tr>
    {% for group, data in five.items %}
        {% if data and data.id %}
        <td class="bg_{{ data.group_state }}"
            {% if active_group and active_group.id == data.id %}
                id="active"
            {% endif %}
        >
            <a href="{% url waiving/fixed_defects sb.id data.id %}#defects">
                {{ group.name }}
            </a>
            {% if data.defects_state %}
            (<span class="{{ data.defects_state }}">{{ data.defects_count }}</span>)
            {% endif %}
            {% if data.diff_state %}
            <span class="{{ data.diff_state }}">{{ data.diff_count }}</span>
            {% endif %}
        </td>
        {% else %}
        <td class="bg_PASSED">
            {{ group.name }}
            {% if data.diff_state %}
            <span class="{{ data.diff_state }}">{{ data.diff_count }}</span>
            {% endif %}
        </td>
        {% endif %}
    {% endfor %}
  </tr>
{% endfor %}
</table>
{% endif %}

{% else %} {# sb.result #}

<h3> {{ not_finished }} </h3>

{% endif %}

{% if task %}
<a href="{% url task/detail sb.task.id %}">Task</a>
{% endif %}

{% if logs %}
<div>
<ul>
{% for log, log_label in logs.iteritems %}
  <li><a href="{% url task/log sb.task.id log %}">{{ log_label }}</a> [<a href="{% url task/log sb.task.id log %}?format=raw">download</a>]</li>
{% endfor %}
</ul>
</div>
{% endif %}

{% if previous_sb or next_sb %}
<div id="result_links">
    {% if first_sb %}
        <span><a href="{% url waiving/result first_sb.id %}">First scan ({{ first_sb.scan.nvr }})</a></span>
    {% else %}
        {% trans "no first scan" %}
    {% endif %}

    |

    {% if previous_sb %}
    <span><a href="{% url waiving/result previous_sb.id %}">Previous scan ({{ previous_sb.scan.nvr }})</a></span>
    {% else %}
        {% trans "no previous scan" %}
    {% endif %}

    |

    {% if next_sb %}
    <span><a href="{% url waiving/result next_sb.id %}">Next scan ({{ next_sb.scan.nvr }})</a></span>
    {% else %}
        {% trans "no next scan" %}
    {% endif %}

    |

    {% if newest_sb %}
    <span><a href="{% url waiving/result newest_sb.id %}">Newest scan ({{ newest_sb.scan.nvr }})</a></span>
    {% else %}
        {% trans "no latest scan" %}
    {% endif %}
</div>
{% endif %}

{% block waiver %}
{% endblock waiver %}

{% endblock content %}
