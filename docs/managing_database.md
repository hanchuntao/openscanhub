# How to manage database

## Entity Relationship Diagram (ERD)

ERD generated by pgadmin (see below) can be find [here](database_ERD.png).

## Postgres Admin web app

If you are not a fan of pure SQL or you need to do something complex with the database, you can use Postgres admin web app. It's already prepared in a container image so its installation is very simple.

For the first usage, run `podman run -it -p 8888:80 --net covscan_internal-network -e 'PGADMIN_DEFAULT_EMAIL=user@redhat.com' -e 'PGADMIN_DEFAULT_PASSWORD=SuperSecret' --name pgadmin docker.io/dpage/pgadmin4:latest`.

* `-p 8888:80` forwards your local port 8888 to the port 80 inside the container where pgadmin listens
* `--net covscan_internal-network` connects the container to the same network as covscanhub and db are connected to. The network is created by `podman-compose` and you can check its name first via `podman network ls`.
* `-e PGADMIN_DEFAULT_*` sets the credentials to use with the web app

Then, you can log into the web app on [localhost:8888](http://localhost:8888/) and set a connection to the database server `db` using username and password from `docker-compose.yml`. The app stores that info so you'll not need to configure it again.

Next time, you only need to start the existing container via `podman start -a pgadmin`.

## Connecting to postgres

```
# su -c "psql" - postgres
psql (8.4.20)
Type "help" for help.

postgres=# \connect covscanhub
psql (8.4.20)
You are now connected to database "covscanhub".
```

You can easily list tables:

```
covscanhub=# \dt
                     List of relations
 Schema |            Name             | Type  |   Owner
--------+-----------------------------+-------+------------
 public | auth_group                  | table | covscanhub
 public | auth_group_permissions      | table | covscanhub
 public | auth_message                | table | covscanhub
 public | auth_permission             | table | covscanhub
 public | auth_user                   | table | covscanhub
 public | auth_user_groups            | table | covscanhub
 public | auth_user_user_permissions  | table | covscanhub
 public | django_admin_log            | table | covscanhub
 public | django_content_type         | table | covscanhub
 public | django_session              | table | covscanhub
 public | django_site                 | table | covscanhub
 public | errata_capability           | table | covscanhub
...
```

List schema:

```
covscanhub=# \d auth_user_user_permissions
                              Table "public.auth_user_user_permissions"
     Column      |  Type   |                                Modifiers
-----------------+---------+-------------------------------------------------------------------------
 id              | integer | not null default nextval('auth_user_user_permissions_id_seq'::regclass)
 longnameuser_id | integer | not null
 permission_id   | integer | not null
Indexes:
    "auth_user_user_permissions_pkey" PRIMARY KEY, btree (id)
    "auth_user_user_permissions_user_id_key" UNIQUE, btree (longnameuser_id, permission_id)
    "auth_user_user_permissions_permission_id" btree (permission_id)
    "auth_user_user_permissions_user_id" btree (longnameuser_id)
Foreign-key constraints:
    "auth_user_user_permissions_permission_id_fkey" FOREIGN KEY (permission_id) REFERENCES auth_permission(id) DEFERRABLE INITIALLY DEFERRED
    "user_id_refs_id_f2045483" FOREIGN KEY (longnameuser_id) REFERENCES auth_user(id) DEFERRABLE INITIALLY DEFERRED
```

## Resolving database issues quickly

Let's say that database is in inconsistent state, migrations were not applied correctly and we need alter database directly.

The issue:

```
ProgrammingError: column "auth_user_user_permissions.user_id" doesn't exist
```

Can be easily resolved:

```
ALTER TABLE auth_user_user_permissions RENAME COLUMN longnameuser_id TO user_id;
```


Removing `NOT NULL` constraint without migrations:

```
ALTER TABLE auth_user_user_permissions ALTER COLUMN longnameuser_id DROP NOT NULL;
```


## Adding users with longer username than 30 characters

```
>>> p = Permission.objects.get(pk=46)
>>> u2 = User.objects.create(username="errata/errata-web-02.host.qe.eng.pek2.redhat.com@REDHAT.COM")
>>> u2.user_permissions.add(p)
```


## Adding user a permission to submit scans

(prereq is that username is long than 30 chars and thus you can't do this in webui)


```
>>> u = User.objects.get(pk=460)  # id of user we want to edit (can be found in URL in admin interface)
>>> u
<User: errata/errata-web-01.host.qe.eng.pek2.redhat.com>

>>> p = Permission.objects.get(pk=46)  # You can find id in admin's html in forms
>>> p
<Permission: scan | permissions | Can submit ET scan via XML-RPC>
>>> u.user_permissions.add(p)
```

That's all. Now refresh admin interface and see if it's really there.
